{% extends "base.html" %}
{% block title %}Suggest Retailer — Cheap Finder{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-8">
  <div>
    <h1 class="text-2xl font-semibold text-white dark:text-white light:text-neutral-900">Suggest a Retailer</h1>
    <p class="text-sm text-neutral-500 mt-1">Add a new Canadian retailer to track. We'll verify the URL and start monitoring it.</p>
  </div>
</div>

<!-- Success/Error messages -->
{% if success_message %}
<div class="bg-green-500/10 border border-green-500/20 rounded-lg px-4 py-3 text-sm text-green-400 mb-6">
  {{ success_message }}
</div>
{% endif %}

{% if error_message %}
<div class="bg-red-500/10 border border-red-500/20 rounded-lg px-4 py-3 text-sm text-red-400 mb-6">
  {{ error_message }}
</div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
  <!-- Left: Suggestion form -->
  <div class="lg:col-span-1">
    <div class="bg-neutral-900 dark:bg-neutral-900 light:bg-white border border-neutral-800 dark:border-neutral-800 light:border-neutral-200 rounded-xl p-6">
      <h3 class="text-sm font-medium text-neutral-400 uppercase tracking-wider mb-4">New Suggestion</h3>
      <form method="POST" action="/suggest-retailer">
        <div class="space-y-4">
          <div>
            <label class="block text-xs font-medium text-neutral-400 mb-1.5">Retailer Name</label>
            <input type="text" name="name" required
                   class="w-full bg-neutral-800 dark:bg-neutral-800 light:bg-neutral-100 border border-neutral-700 dark:border-neutral-700 light:border-neutral-300 rounded-lg px-3 py-2 text-sm text-white dark:text-white light:text-neutral-900 focus:outline-none focus:border-green-500 transition-colors"
                   placeholder="e.g. Little Burgundy">
          </div>
          <div>
            <label class="block text-xs font-medium text-neutral-400 mb-1.5">Website URL</label>
            <input type="url" name="url" required
                   class="w-full bg-neutral-800 dark:bg-neutral-800 light:bg-neutral-100 border border-neutral-700 dark:border-neutral-700 light:border-neutral-300 rounded-lg px-3 py-2 text-sm text-white dark:text-white light:text-neutral-900 focus:outline-none focus:border-green-500 transition-colors"
                   placeholder="https://www.littleburgundyshoes.com">
          </div>
        </div>
        <p class="text-[11px] text-neutral-600 mt-3">We'll check if the URL is reachable. If it passes, the retailer will be added automatically using a generic scraper.</p>
        <button type="submit"
                class="w-full mt-4 bg-green-600 hover:bg-green-500 text-white text-sm font-medium py-2.5 px-4 rounded-lg transition-colors">
          Submit &amp; Verify
        </button>
      </form>
    </div>
  </div>

  <!-- Right: Active retailers + suggestion history -->
  <div class="lg:col-span-2 space-y-8">
    <!-- Current Retailers -->
    <section>
      <h2 class="text-sm font-medium text-neutral-400 uppercase tracking-wider mb-4">
        Active Retailers ({{ retailers | length }})
      </h2>
      {% if retailers %}
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        {% for r in retailers %}
        {% set product_count = retailer_product_counts.get(r.id, 0) %}
        {% set is_skipped = r.scraper_type in skip_scrapers %}
        <div class="bg-neutral-900 dark:bg-neutral-900 light:bg-white border border-neutral-800 dark:border-neutral-800 light:border-neutral-200 rounded-lg p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3 min-w-0">
              <!-- Status dot: green=has products, red=skipped/broken, yellow=no products yet -->
              <div class="w-2 h-2 rounded-full shrink-0
                {% if is_skipped %}bg-red-500
                {% elif product_count > 0 %}bg-green-500
                {% else %}bg-yellow-500{% endif %}" title="{% if is_skipped %}Scraper skipped{% elif product_count > 0 %}Working{% else %}No products yet{% endif %}"></div>
              <div class="min-w-0">
                <p class="text-sm font-medium text-white dark:text-white light:text-neutral-900 truncate">{{ r.name }}</p>
                <a href="{{ r.base_url }}" target="_blank" rel="noopener noreferrer"
                   class="text-xs text-neutral-500 hover:text-green-500 transition-colors truncate block">{{ r.base_url }}</a>
              </div>
            </div>
            <div class="flex items-center gap-2 shrink-0 ml-2">
              <button type="button" onclick="document.getElementById('edit-retailer-{{ r.id }}').classList.remove('hidden')"
                      class="text-neutral-500 hover:text-blue-400 transition-colors p-1" title="Edit retailer name">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
              </button>
              <span class="text-[10px] text-neutral-500 bg-neutral-800 dark:bg-neutral-800 light:bg-neutral-100 px-2 py-1 rounded">{{ r.scraper_type }}</span>
            </div>
          </div>
          <div class="mt-3 pt-3 border-t border-neutral-800 dark:border-neutral-800 light:border-neutral-200">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <!-- Product count badge -->
                <span class="text-xs {% if product_count > 0 %}text-green-400{% else %}text-neutral-500{% endif %}">
                  {{ product_count }} product{{ 's' if product_count != 1 else '' }}
                </span>
                <!-- Status label -->
                {% if is_skipped %}
                <span class="text-[10px] text-red-400 bg-red-500/10 px-2 py-0.5 rounded">Scraper skipped</span>
                {% elif product_count == 0 %}
                <span class="text-[10px] text-yellow-400 bg-yellow-500/10 px-2 py-0.5 rounded">Pending discovery</span>
                {% endif %}
              </div>
              <div class="flex items-center gap-2">
                <!-- Retry / Re-discover button -->
                {% if not is_skipped %}
                <button type="button"
                        id="discover-btn-{{ r.id }}"
                        onclick="startDiscovery({{ r.id }})"
                        class="text-xs text-neutral-400 hover:text-green-400 bg-neutral-800 dark:bg-neutral-800 light:bg-neutral-100 hover:bg-neutral-700 dark:hover:bg-neutral-700 light:hover:bg-neutral-200 px-2.5 py-1 rounded transition-colors"
                        title="Re-discover products for all brands at this retailer">
                  ↻ Re-discover
                </button>
                {% endif %}
                <!-- Delete button -->
                <form method="POST" action="/retailers/{{ r.id }}/delete" class="inline"
                      data-name="{{ r.name }}"
                      onsubmit="return confirm('Delete ' + this.dataset.name + '? This will remove all products from this retailer. This cannot be undone.')">
                  <button type="submit"
                          class="text-xs text-neutral-400 hover:text-red-400 bg-neutral-800 dark:bg-neutral-800 light:bg-neutral-100 hover:bg-red-500/10 px-2.5 py-1 rounded transition-colors"
                          title="Delete retailer">
                    ✕ Delete
                  </button>
                </form>
              </div>
            </div>
            <!-- Discovery progress area -->
            <div id="discover-progress-{{ r.id }}" class="hidden mt-2"></div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-neutral-500 text-sm">No retailers configured yet.</p>
      {% endif %}
    </section>

    <!-- Suggestion History -->
    <section>
      <h2 class="text-sm font-medium text-neutral-400 uppercase tracking-wider mb-4">
        Suggestion History ({{ suggestions | length }})
      </h2>

      {% if suggestions %}
      <div class="space-y-3">
        {% for s in suggestions %}
        <div class="bg-neutral-900 dark:bg-neutral-900 light:bg-white border border-neutral-800 dark:border-neutral-800 light:border-neutral-200 rounded-lg p-4 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-2 h-2 rounded-full
              {% if s.status == 'approved' %}bg-green-500
              {% elif s.status == 'failed' %}bg-red-500
              {% else %}bg-yellow-500{% endif %}"></div>
            <div>
              <p class="text-sm font-medium text-white dark:text-white light:text-neutral-900">{{ s.name }}</p>
              <a href="{{ s.url }}" target="_blank" rel="noopener noreferrer"
                 class="text-xs text-neutral-500 hover:text-green-500 transition-colors">{{ s.url }}</a>
            </div>
          </div>
          <div class="flex items-center gap-3 text-xs shrink-0">
            {% if s.health_check_ok is not none %}
            <span class="hidden sm:inline {% if s.health_check_ok %}text-green-400{% else %}text-red-400{% endif %}">
              {{ s.health_check_message }}
            </span>
            {% endif %}
            <span class="px-2 py-1 rounded capitalize
              {% if s.status == 'approved' %}text-green-400 bg-green-500/10
              {% elif s.status == 'failed' %}text-red-400 bg-red-500/10
              {% else %}text-yellow-400 bg-yellow-500/10{% endif %}">
              {{ s.status }}
            </span>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="bg-neutral-900 dark:bg-neutral-900 light:bg-white border border-neutral-800 dark:border-neutral-800 light:border-neutral-200 rounded-lg p-8 text-center">
        <p class="text-neutral-500 text-sm">No suggestions yet. Submit a retailer URL above to get started.</p>
      </div>
      {% endif %}
    </section>
  </div>
</div>

<!-- Edit Retailer Modals -->
{% for r in retailers %}
<div id="edit-retailer-{{ r.id }}" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm"
     onclick="if(event.target===this) this.classList.add('hidden')">
  <div class="bg-neutral-900 dark:bg-neutral-900 light:bg-white border border-neutral-800 dark:border-neutral-800 light:border-neutral-200 rounded-xl p-6 w-full max-w-md mx-4">
    <h3 class="text-lg font-semibold text-white dark:text-white light:text-neutral-900 mb-4">Edit Retailer</h3>
    <form method="POST" action="/retailers/{{ r.id }}/edit">
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-neutral-400 mb-1.5">Retailer Name</label>
          <input type="text" name="name" required value="{{ r.name }}"
                 class="w-full bg-neutral-800 dark:bg-neutral-800 light:bg-neutral-100 border border-neutral-700 dark:border-neutral-700 light:border-neutral-300 rounded-lg px-3 py-2 text-sm text-white dark:text-white light:text-neutral-900 focus:outline-none focus:border-green-500 transition-colors">
        </div>
        <div>
          <label class="block text-xs font-medium text-neutral-400 mb-1.5">Website URL</label>
          <p class="text-sm text-neutral-400 bg-neutral-800 dark:bg-neutral-800 light:bg-neutral-100 border border-neutral-700 dark:border-neutral-700 light:border-neutral-300 rounded-lg px-3 py-2 truncate">{{ r.base_url }}</p>
          <p class="text-[11px] text-neutral-600 mt-1">URL cannot be changed after creation.</p>
        </div>
      </div>
      <div class="flex items-center gap-3 mt-6">
        <button type="submit"
                class="flex-1 bg-green-600 hover:bg-green-500 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors">
          Save Changes
        </button>
        <button type="button" onclick="document.getElementById('edit-retailer-{{ r.id }}').classList.add('hidden')"
                class="flex-1 bg-neutral-800 dark:bg-neutral-800 light:bg-neutral-200 hover:bg-neutral-700 dark:hover:bg-neutral-700 light:hover:bg-neutral-300 text-neutral-300 dark:text-neutral-300 light:text-neutral-700 text-sm font-medium py-2 px-4 rounded-lg transition-colors">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>
{% endfor %}

<script>
function startDiscovery(retailerId) {
  var btn = document.getElementById('discover-btn-' + retailerId);
  var progressDiv = document.getElementById('discover-progress-' + retailerId);

  // Disable button and show starting state
  btn.disabled = true;
  btn.classList.add('opacity-50', 'cursor-not-allowed');
  btn.textContent = '↻ Starting...';

  // Fire POST to start discovery
  fetch('/retailers/' + retailerId + '/discover', {
    method: 'POST',
  })
  .then(function(resp) { return resp.json(); })
  .then(function(data) {
    if (data.status === 'already_running' || data.status === 'started') {
      // Hide button, show progress area
      btn.classList.add('hidden');
      progressDiv.classList.remove('hidden');
      progressDiv.innerHTML = '<span class="text-xs text-neutral-500">Connecting...</span>';

      // Open SSE connection
      var evtSource = new EventSource('/retailers/' + retailerId + '/discover-progress');

      evtSource.onmessage = function(event) {
        var progress = JSON.parse(event.data);

        if (progress.status === 'idle') {
          evtSource.close();
          resetButton(retailerId);
          return;
        }

        if (progress.status === 'running') {
          var pct = progress.brands_total > 0
            ? Math.round((progress.brands_done / progress.brands_total) * 100)
            : 0;

          progressDiv.innerHTML =
            '<div class="flex flex-col gap-1.5">' +
              '<div class="flex items-center justify-between">' +
                '<div class="flex items-center gap-2">' +
                  '<span class="inline-block animate-spin text-green-400 text-xs">↻</span>' +
                  '<span class="text-xs text-neutral-300">' +
                    progress.brands_done + '/' + progress.brands_total + ' brands' +
                  '</span>' +
                '</div>' +
                (progress.products_found > 0
                  ? '<span class="text-[10px] text-green-400">' + progress.products_found + ' found</span>'
                  : '') +
              '</div>' +
              '<div class="w-full bg-neutral-800 rounded-full h-1.5 overflow-hidden">' +
                '<div class="bg-green-500 h-1.5 rounded-full transition-all duration-500 ease-out" style="width: ' + pct + '%"></div>' +
              '</div>' +
              '<span class="text-[10px] text-neutral-500 truncate">' +
                (progress.current_brand ? 'Searching ' + progress.current_brand + '...' : '') +
              '</span>' +
            '</div>';
        }

        if (progress.status === 'done') {
          evtSource.close();
          progressDiv.innerHTML =
            '<div class="flex items-center gap-2 py-0.5">' +
              '<span class="text-xs text-green-400">&#10003; ' + progress.message + '</span>' +
            '</div>';

          // Auto-fade after 8 seconds, then restore button
          setTimeout(function() {
            progressDiv.style.transition = 'opacity 0.5s';
            progressDiv.style.opacity = '0';
            setTimeout(function() {
              resetButton(retailerId);
            }, 500);
          }, 8000);
        }

        if (progress.status === 'error') {
          evtSource.close();
          progressDiv.innerHTML =
            '<div class="flex items-center gap-2 py-0.5">' +
              '<span class="text-xs text-red-400">&#10007; ' + progress.message + '</span>' +
            '</div>';
          setTimeout(function() { resetButton(retailerId); }, 10000);
        }
      };

      evtSource.onerror = function() {
        evtSource.close();
        progressDiv.innerHTML =
          '<span class="text-xs text-red-400">Connection lost</span>';
        setTimeout(function() { resetButton(retailerId); }, 5000);
      };
    }
  })
  .catch(function(err) {
    console.error('Discovery start failed:', err);
    btn.disabled = false;
    btn.classList.remove('opacity-50', 'cursor-not-allowed');
    btn.textContent = '↻ Re-discover';
  });
}

function resetButton(retailerId) {
  var btn = document.getElementById('discover-btn-' + retailerId);
  var progressDiv = document.getElementById('discover-progress-' + retailerId);

  btn.classList.remove('hidden', 'opacity-50', 'cursor-not-allowed');
  btn.disabled = false;
  btn.textContent = '↻ Re-discover';

  progressDiv.classList.add('hidden');
  progressDiv.style.opacity = '1';
  progressDiv.innerHTML = '';
}
</script>
{% endblock %}
